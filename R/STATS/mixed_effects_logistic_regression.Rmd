---
title: "Mixed Effects Logistic Regressions"
output:
  html_document:
    df_print: paged
    code_folding: hide
---
```{r}
library(ggplot2)
library(lme4)
library(data.table)
source("../REF_FUNCTIONS/explore_functions.r")
```


The first goal is to fit logistic curves to P(choose Right) as a function of signed coherence, by subject (row1), by VD (col1), by presenceCP (row2), by session (col2). I should estimate the true block's proportion.
```{r}
data <- get_full_data()
head(data)
```

But to make things simpler at the beginning, let's fix V=400 and presenceCP="noCP".
```{r}
s = data[viewingDuration == 400 & presenceCP=="noCP"]
s[initDirection == "left", scoh:=-coherence]
s[initDirection == "right", scoh:=coherence]
s[,date:=as.factor(date)]
# s <- s[!is.na(scoh)]
head(s)
```


```{r}
fit <- s[, list(
  scoh, day,
  fitted = glm(data = .SD, formula = dirChoice ~ scoh ,family = binomial(link = logit))$fitted
  ),
  by=.(subject, date)]
head(fit)
```

```{r, fig.width=10, fig.height=10}
ggplot(fit, aes(x=scoh, y=fitted, col=date, group=date)) + 
  geom_line() + geom_hline(yintercept = 0.5, linetype="dashed") + geom_vline(xintercept = 0, linetype="dashed")+
  # geom_point(aes(x=scoh, y=propRight), 
  #              inherit.aes=FALSE, 
  #              data=s[,.(propRight=sum(dirChoice=='right')/.N),by=.(scoh, subject, date)])
  facet_grid(subject ~ day)
```


```{r}
# ggplot(s, aes(x=scoh)) + geom_smooth(method="glm", )
```











<!--

# Effect of probCP (random subject) on dirCorrect at 200 (and 100) msec
```{r}
data <- get_full_data(probCPasFactor = F)
subdata <- data[block!="Quest" & viewingDuration == 200 & coh_cat == "th", .(subject, dirCorrect, block, probCP)]
str(subdata)
```

## Standard logistic regression
```{r}
m <- glm(dirCorrect ~ probCP, data = subdata, family = binomial)  # no need to specify "no-CP" for 200-msec trials
summary(m)
```

```{r}
coef(m)
xvals <- seq(0,0.8,.1)
fitted_line_dt <- data.table(x=xvals, y=coef(m)[["(Intercept)"]] + coef(m)[["probCP"]]*xvals)
# print(fitted_line_dt)
```

Let's visualize the fits in log-odds space.
```{r}
logodds_data <- subdata[,logodds:=(sum(dirCorrect)/(.N - sum(dirCorrect))), by=probCP]
ggplot(logodds_data, aes(x=probCP, y=logodds)) + geom_point() + 
  geom_line(data=fitted_line_dt, aes(x=x,y=y))
```
This looks horrible... WHY?

## Adding random intercept for each subject
```{r}
m1 <- glmer(dirCorrect ~ probCP + (1 | subject), data=subdata, family = binomial, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
summary(m1)
```

```{r}
coef(m1)$subject
```

## Adding random slope for each subject
```{r}
m2 <- glmer(dirCorrect ~ probCP + (1 | subject) + (1 + probCP | subject), data=subdata, family = binomial, control = glmerControl(optimizer = "bobyqa"))
summary(m2)
```

```{r}
coef(m2)$subject
```

```{r}
isSingular(m2)
```

# Interpretation / Conclusion
??

-->