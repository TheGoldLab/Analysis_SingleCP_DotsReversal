---
title: "Simulations Psychophysics Single Change Point"
author: Adrian Radillo
output: html_notebook
---

<!-- cheat sheet
 executing chunk *Ctrl+Shift+Enter*. 
 Add new chunk *Ctrl+Alt+I*.
 press *Ctrl+Shift+K* to preview the HTML file.
-->
```{r}
# load required libraries for the notebook
library('sde')
library('fBasics')
library('ggplot2')
library('reshape2')
rm(list=ls()) # clear existing vars in environment
```

# Produce trajectories for various models
## PA model
```{r}
#Set up parameters
d0 <- 1.5 # drift magnitude
s0 <- 1 # stdev magnitude
cp <- 0.2 # change point time

viewing_duration <- .4;

num_traj=1;
num_time_points=500;
t <- 0:num_time_points  # time
dt <- 1/num_time_points # time step in sec
tt <- seq(0,viewing_duration, length.out=num_time_points + 1) # in sec
cp_idx <- floor(num_time_points/2)

#Simulate 'num_traj' trajectories from the normative model
s <- expression(s0)
d <- expression(d0*(Heaviside(-t,-cp)-Heaviside(t,cp)))
nocpd <- expression(d0)
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> PAmodel
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=nocpd,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> PAmodelNoCP

## Linear-leak models
#Simulate 'num_traj' trajectories from the linear-leak model
lowLeak <- 3
d <- expression(d0*(Heaviside(-t,-cp)-Heaviside(t,cp))-lowLeak*x)
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> linModelLowLeak
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=nocpd,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> linModelLowLeakNoCP

highLeak <- 10
d <- expression(d0*(Heaviside(-t,-cp)-Heaviside(t,cp))-highLeak*x)
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> linModelHighLeak
sde.sim(t0 = 0, T = viewing_duration, X0 = 0, N = num_time_points, drift=nocpd,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> linModelHighLeakNoCP

## Reset models
# ZERO RESET
short_viewing_duration <- .2;

num_time_points_short=num_time_points / 2;

#Simulate 'num_traj' trajectories from the normative model
d <- expression(d0)
sde.sim(t0 = 0, T = short_viewing_duration, X0 = 0, N = num_time_points_short, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> ZeroResetmodel1

new_drift <- expression(-d0)
sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = 0, N = num_time_points_short-1, drift=new_drift,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> ZeroResetmodel2  # CP

sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = 0, N = num_time_points_short-1, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> ZeroResetmodel3  # NO CP

# CLEVER RESETS

# First Epoch (pre CP)
sde.sim(t0 = 0, T = short_viewing_duration, X0 = 0, N = num_time_points_short, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> LowhResetmodel1
sde.sim(t0 = 0, T = short_viewing_duration, X0 = 0, N = num_time_points_short, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> HighhResetmodel1

lowh <- 0.2
highh <- 0.8

# get end values of 2N trajectories
all_end <- as.vector(c(LowhResetmodel1[num_time_points_short + 1,],HighhResetmodel1[num_time_points_short+1,]))

reset_evidence <- function(ev, h) {
  return(ev + log((h * exp(-ev)+1-h)/(h * exp(ev)+1-h)))
}

# reset half of them with low h and the other half with high h
lowh_reset_vals <- reset_evidence(all_end[1:num_traj/2], lowh)
highh_reset_vals <- reset_evidence(all_end[num_traj/2+1:num_traj], highh)

# simulate second epoch with appropriate starting points
# Don't forget the possibly new drift rate!

sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = lowh_reset_vals, N = num_time_points_short-1, drift=new_drift,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> LowhResetmodel2
sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = highh_reset_vals, N = num_time_points_short-1, drift=new_drift,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> HighhResetmodel2

sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = lowh_reset_vals, N = num_time_points_short-1, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> LowhResetmodel2NoCP
sde.sim(t0 = cp+.01, T = cp+short_viewing_duration, X0 = highh_reset_vals, N = num_time_points_short-1, drift=d,
        sigma=s, sigma.x=0, method = "euler",M=num_traj) -> HighhResetmodel2NoCP

# Comparison of mean trajectories between the two models

# get mean trajectories
meanPA <- rowMeans(PAmodel)
meanLinLow <- rowMeans(linModelLowLeak)
meanLinHigh <- rowMeans(linModelHighLeak)
meanZeroReset <- c(rowMeans(ZeroResetmodel1), rowMeans(ZeroResetmodel2))
meanLowhReset <- c(rowMeans(LowhResetmodel1), rowMeans(LowhResetmodel2))
meanHighhReset <- c(rowMeans(HighhResetmodel1), rowMeans(HighhResetmodel2))
meanPAnocp <- rowMeans(PAmodelNoCP)
meanLinLownocp <- rowMeans(linModelLowLeakNoCP)
meanLinHighnocp <- rowMeans(linModelHighLeakNoCP)
meanZeroResetnocp <- c(rowMeans(ZeroResetmodel1), rowMeans(ZeroResetmodel3))
meanLowhResetnocp <- c(rowMeans(LowhResetmodel1), rowMeans(LowhResetmodel2NoCP))
meanHighhResetnocp <- c(rowMeans(HighhResetmodel1), rowMeans(HighhResetmodel2NoCP))
means_df <- data.frame("time" = tt,
                       "PAcp" = meanPA,
                       "lowLeakcp" = meanLinLow,
                       "HighLeakcp" = meanLinHigh,
                       "ZeroResetcp" = meanZeroReset,
                       "LowHresetcp" = meanLowhReset,
                       "HighHresetcp" = meanHighhReset,
                       "PAnoCP" = meanPAnocp,
                       "lowLeaknoCP" = meanLinLownocp,
                       "HighLeaknoCP" = meanLinHighnocp,
                       "ZeroResetnoCP" = meanZeroResetnocp,
                       "LowHresetnoCP" = meanLowhResetnocp,
                       "HighHresetnoCP" = meanHighhResetnocp)
```

```{r, fig.width=10, fig.height=10}
library(data.table)
# plotting script
options(scipen=999)
theme_set(theme_bw())

# Load data (to be developed) ------------------------------------------
X <- melt(means_df,id=c("time"))
head(X)
colnames(X)[2] <- "model"

X <- as.data.table(X)
X[,`:=`(modelClass="Reset")]
X[model=="PAcp" | model=="PAnoCP",modelClass:="Perfect Accum."]
X[model=="lowLeakcp" | model=="HighLeakcp" | model=="lowLeaknoCP" | model=="HighLeaknoCP", modelClass:="Leak"]
X[,modelClass:=factor(modelClass, levels = c("Perfect Accum.", "Leak", "Reset"))]

X[,CP:="CP"]
X[model == "PAnoCP" |
    model == "lowLeaknoCP" | 
    model == "HighLeaknoCP" | 
    model == "ZeroResetnoCP" | 
    model == "LowHresetnoCP" | 
    model == "HighHresetnoCP", CP:="no-CP"]
X[,CP:=factor(CP)]
X$CP = factor(X$CP,levels(X$CP)[c(2,1)])

X[,model2:="PA"]
X[model == "lowLeaknoCP" | model == "lowLeakcp", model2:="LowLeak"]
X[model == "HighLeaknoCP" | model == "HighLeakcp", model2:="HighLeak"]
X[model == "ZeroResetnoCP" | model == "ZeroResetcp", model2:="ZeroReset"]
X[model == "LowHresetnoCP" | model == "LowHresetcp", model2:="lowHreset"]
X[model == "HighHresetnoCP" | model == "HighHresetcp", model2:="highHreset"]

X[,model2:=factor(model2)]
X$model2 = factor(X$model2,levels(X$model2)[c(5,4,2,6,3,1)])

cp_time=0.2

# Add plot components --------------------------------
gg <- ggplot(X, aes(x=time, y=value)) + 
  geom_line(aes(col=model2), size=1.5) + 
  geom_vline(xintercept = cp_time, linetype="dashed", 
             color = "blue", size=1.5) +
  geom_hline(yintercept = 0, color="black")+
  facet_grid(modelClass~CP) +
  xlim(c(0, .4)) + #ylim(c(-1, 1)) + 
  labs(title="Mean Trajectories", y="evidence", x="time",subtitle=paste(num_traj,"realizations", sep=" "))


# Modify theme components -------------------------------------------
bf <- 20
sf <- 17
gg + theme(plot.title=element_text(size=bf, 
                                   face="bold", 
                                   lineheight=1.2),  # title
           plot.subtitle=element_text(size=sf-3, 
                                      family="American Typewriter"),  # subtitle
           plot.caption=element_text(size=sf),  # caption
           axis.title.x=element_text(size=(sf+2)),  # X axis title
           axis.title.y=element_text(size=(sf+2)),  # Y axis title
           axis.text.x=element_text(size=sf),  # X axis text
           axis.text.y=element_text(size=sf), # Y axis text
           legend.title = element_text(size=sf, color = "firebrick"),
           legend.text = element_text(size=sf-2),
           panel.grid.minor = element_blank()) # remove minor grid
```

<!-- # Comparison of accuracy profiles between the two models -->
<!-- ```{r} -->
<!-- pos <- PAmodel>0 -->
<!-- neg <- PAmodel<=0 -->
<!-- spos<-rowSums(pos) -->
<!-- sneg<-rowSums(neg) -->
<!-- accPA <- c(spos[1:cp_idx],sneg[(cp_idx+1):(num_time_points+1)]) / num_traj -->

<!-- pos <- linModelLowLeak>0 -->
<!-- neg <- linModelLowLeak<=0 -->
<!-- spos<-rowSums(pos) -->
<!-- sneg<-rowSums(neg) -->
<!-- accLinLow <- c(spos[1:cp_idx],sneg[(cp_idx+1):(num_time_points+1)]) / num_traj -->

<!-- pos <- linModelHighLeak>0 -->
<!-- neg <- linModelHighLeak<=0 -->
<!-- spos<-rowSums(pos) -->
<!-- sneg<-rowSums(neg) -->
<!-- accLinHigh <- c(spos[1:cp_idx],sneg[(cp_idx+1):(num_time_points+1)]) / num_traj -->

<!-- pos <- linModelHighLeak>0 -->
<!-- neg <- linModelHighLeak<=0 -->
<!-- spos<-rowSums(pos) -->
<!-- sneg<-rowSums(neg) -->
<!-- accLinHigh <- c(spos[1:cp_idx],sneg[(cp_idx+1):(num_time_points+1)]) / num_traj -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # plot commands -->
<!-- accuracy_df <- data.frame("time" = tt,  -->
<!--                  "normModel" = accPA, -->
<!--                  "linModelLow" = accLinLow,  -->
<!--                  "linModelHigh"= accLinHigh) -->
<!-- #write.csv(df,"acc_means.csv") -->

<!-- df <- melt(accuracy_df,id=c("time")) -->
<!-- colnames(df)[2] <- "model" -->
<!-- cp_time=0.2 -->

<!-- # Add plot components -------------------------------- -->
<!-- gg <- ggplot(df, aes(x=time, y=value)) +  -->
<!--   geom_line(aes(col=model), size=1.5) +  -->
<!--   geom_vline(xintercept = cp_time, linetype="dashed",  -->
<!--              color = "blue", size=1.5) + -->
<!--   geom_hline(yintercept = 0, color="black")+ -->
<!--   xlim(c(0.0001, viewing_duration)) + ylim(c(0, 1)) +  -->
<!--   labs(title="Accuracy", y="% correct", x="time",subtitle="1,000 realizations") -->

<!-- # Modify theme components ------------------------------------------- -->
<!-- bf <- 20 -->
<!-- sf <- 17 -->
<!-- gg + theme(plot.title=element_text(size=bf,  -->
<!--                                    face="bold",  -->
<!--                                    lineheight=1.2),  # title -->
<!--            plot.subtitle=element_text(size=sf-3,  -->
<!--                                       family="American Typewriter"),  # subtitle -->
<!--            plot.caption=element_text(size=sf),  # caption -->
<!--            axis.title.x=element_text(size=(sf+2)),  # X axis title -->
<!--            axis.title.y=element_text(size=(sf+2)),  # Y axis title -->
<!--            axis.text.x=element_text(size=sf),  # X axis text -->
<!--            axis.text.y=element_text(size=sf), # Y axis text -->
<!--            legend.title = element_text(size=sf, color = "firebrick"), -->
<!--            legend.text = element_text(size=sf-2), -->
<!--            panel.grid.minor = element_blank()) # remove minor grid -->
<!-- ``` -->

