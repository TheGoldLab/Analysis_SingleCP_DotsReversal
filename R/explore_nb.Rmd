---
title: "Exploratory Notebook"
output:
  html_document:
    df_print: paged
    code_folding: hide
---
<!--
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
-->

# Hello!
```{r}
#install.packages("ggforce")
```

```{r}
library(data.table)
library(ggforce)
```
```{r}
get_full_data <- function() {
  # block that imports the data and casts it into useful types for R
  data <- fread('/home/adrian/SingleCP_DotsReversal/processed/all_valid_data.csv')
  
  # set variables with appropriate type
  data[, `:=`(
    subject=as.factor(subject),
    dirChoice=as.factor(dirChoice),
    cpChoice=factor(cpChoice),  # doesn't create level for NA values
    dirCorrect=as.integer(dirCorrect),
    cpCorrect=as.integer(cpCorrect),
    initDirection=as.factor(initDirection),
    endDirection=as.factor(endDirection),
    presenceCP=factor(presenceCP, ordered=TRUE),
    viewingDuration=as.integer(viewingDuration * 1000),
    CPresponseSide=factor(CPresponseSide),
    block=factor(block, levels=c('Quest', 'Block2', 'Block3', 'Block4', 'Block5', 'Block6', 'Block7',
                                 'Block8', 'Block9', 'Block10', 'Block11')),
    probCP=factor(probCP, ordered=TRUE)
  )]
  
  # render levels more human-friendly
  levels(data$dirChoice) <- c('left', 'right')
  levels(data$cpChoice) <- c('no-CP', 'CP')
  levels(data$initDirection) <- c('right', 'left')
  levels(data$endDirection) <- c('right', 'left')
  levels(data$presenceCP) <- c('no-CP', 'CP')
  levels(data$CPresponseSide) <- c('left', 'right')
  
  return(data)
}

```


```{r}
data <- get_full_data()
str(data)
```

```{r}
# Example of confusion matrix-like table for choice vs. true direction of motion
build_confusion_table <- function(subj, session, block_name, coh, vd) {
  confusion <- table(
    data[subject==subj &
           date==session &
           block==block_name & 
           coherence==coh & 
           viewingDuration == vd,
         .(dirChoice, initDirection)]
  )
  pc <- confusion
  print(pc)
}
```


```{r}
# builds data.frame of arcs corresponding to a confusion table
build_arcs <- function(confusion_table) {
  dt <- as.data.table(confusion_table)
  
  trueLeft <- dt[initDirection == "left", sum(N)]
  trueRight <- dt[initDirection == "right", sum(N)]
  choseLeft <- dt[dirChoice == "left", sum(N)]
  choseRight <- dt[dirChoice == "right", sum(N)]
  
  totTrials <- trueLeft + trueRight
  angle <- 2*pi/totTrials
  
  # build arc for true direction
  start <- c(0, trueRight*angle)
  end <- c(trueRight*angle, 2*pi)
  r <- c(.52, .52, 1, 1)
  side <- factor(c('right', 'left', 'right', 'left'))
  
  # build arc for chosen direction
  startRight <- -dt[dirChoice == "right" & initDirection == "left", N]*angle
  endRight <- startRight + choseRight*angle
  
  startLeft <- endRight
  endLeft <- 2*pi + startRight
  
  start <- c(start, startRight, startLeft)
  end <- c(end, endRight, endLeft)
  
  arcs <- data.frame(start, end, r, side)
  
  return(arcs)
}
```

```{r}
# arc_data is data.table returned by build_arcs()
plot_donut <- function(arc_data) {
  g <- ggplot(arc_data) +
    geom_arc(aes(x0 = 0, y0 = 0, r = r, start = start, end = end,
                 color = side), size=25) + 
    coord_fixed(xlim=c(-1.2,1.2), ylim=c(-1.2,1.2)) +
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.ticks.y=element_blank(),
          axis.text.y=element_blank(),
          axis.title.y=element_blank(),
          legend.text=element_text(size=16),
          legend.title = element_text(size=16)) 
  return(g)
}
```

```{r}
s <- "S1"
ss <- c("2019_06_20_12_54", "2019_06_21_13_08", "2019_06_27_11_33")
bn <- 'Block2'
c <- 0
v <- 400
for (sss in ss) {
  p <- plot_donut(build_arcs(build_confusion_table(s, sss, bn, c, v)))
  plot(p)
}
```

